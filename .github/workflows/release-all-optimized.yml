name: Multi-Platform Release (Optimized)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (v1.0.0)"
        required: true
        type: string
      skip_tests:
        description: "Skip test verification"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      skip_linux:
        description: "Skip Linux builds"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      skip_windows:
        description: "Skip Windows builds"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      skip_macos:
        description: "Skip macOS build"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      skip_mobile:
        description: "Skip Android/iOS builds"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
  push:
    tags:
      - "v*"

env:
  CACHE_VERSION: v1
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================
  # Detect changes and determine what to build
  # ============================================================

  detect-changes:
    name: Detect Changes & Generate Cache Keys
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      build_linux: ${{ steps.changes.outputs.build_linux }}
      build_windows: ${{ steps.changes.outputs.build_windows }}
      build_macos: ${{ steps.changes.outputs.build_macos }}
      build_android: ${{ steps.changes.outputs.build_android }}
      cache_key_python: ${{ steps.cache-keys.outputs.python }}
      cache_key_rust: ${{ steps.cache-keys.outputs.rust }}
      cache_key_nix: ${{ steps.cache-keys.outputs.nix }}
      python_deps_unchanged: ${{ steps.deps-status.outputs.python_unchanged }}
      rust_deps_unchanged: ${{ steps.deps-status.outputs.rust_unchanged }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          VERSION="${VERSION#v}"
          
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(alpha|beta|rc)\.[0-9]+)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          if [[ "$VERSION" == *"-alpha"* ]] || [[ "$VERSION" == *"-beta"* ]] || [[ "$VERSION" == *"-rc"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi
          
          echo "âœ… Version: $VERSION"

      - name: Detect which platforms to build
        id: changes
        run: |
          # Dynamic build detection
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual dispatch: use explicit skip flags
            BUILD_LINUX=$([ "${{ github.event.inputs.skip_linux }}" == "false" ] && echo "true" || echo "false")
            BUILD_WINDOWS=$([ "${{ github.event.inputs.skip_windows }}" == "false" ] && echo "true" || echo "false")
            BUILD_MACOS=$([ "${{ github.event.inputs.skip_macos }}" == "false" ] && echo "true" || echo "false")
            BUILD_ANDROID=$([ "${{ github.event.inputs.skip_mobile }}" == "false" ] && echo "true" || echo "false")
          else
            # Tag push: smart detection
            # Check if Python/Rust code changed
            if git diff HEAD~1 HEAD --quiet -- 'src/**' 'rust/**' 'Cargo.toml'; then
              BUILD_LINUX="false"
            else
              BUILD_LINUX="true"
            fi
            # Always build Windows/macOS/Android on tag
            BUILD_WINDOWS="true"
            BUILD_MACOS="true"
            BUILD_ANDROID="true"
          fi
          
          echo "build_linux=$BUILD_LINUX" >> $GITHUB_OUTPUT
          echo "build_windows=$BUILD_WINDOWS" >> $GITHUB_OUTPUT
          echo "build_macos=$BUILD_MACOS" >> $GITHUB_OUTPUT
          echo "build_android=$BUILD_ANDROID" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Build matrix:"
          echo "  Linux:   $BUILD_LINUX"
          echo "  Windows: $BUILD_WINDOWS"
          echo "  macOS:   $BUILD_MACOS"
          echo "  Android: $BUILD_ANDROID"

      - name: Generate dependency hash cache keys
        id: cache-keys
        run: |
          # Hash dependencies for cache invalidation
          PYTHON_HASH=$(sha256sum uv.lock pyproject.toml 2>/dev/null | sha256sum | cut -c1-12)
          RUST_HASH=$(sha256sum Cargo.lock Cargo.toml 2>/dev/null | sha256sum | cut -c1-12)
          NIX_HASH=$(sha256sum flake.lock flake.nix 2>/dev/null | sha256sum | cut -c1-12)
          
          echo "python=${{ env.CACHE_VERSION }}-py-$PYTHON_HASH" >> $GITHUB_OUTPUT
          echo "rust=${{ env.CACHE_VERSION }}-rs-$RUST_HASH" >> $GITHUB_OUTPUT
          echo "nix=${{ env.CACHE_VERSION }}-nix-$NIX_HASH" >> $GITHUB_OUTPUT
          
          echo "ðŸ”‘ Cache keys generated:"
          echo "  Python: ${{ env.CACHE_VERSION }}-py-$PYTHON_HASH"
          echo "  Rust:   ${{ env.CACHE_VERSION }}-rs-$RUST_HASH"
          echo "  Nix:    ${{ env.CACHE_VERSION }}-nix-$NIX_HASH"

      - name: Check if dependencies are unchanged
        id: deps-status
        run: |
          # If we have this cache, deps are unchanged
          if git ls-files -d | grep -q "uv.lock\|Cargo.lock"; then
            echo "python_unchanged=false" >> $GITHUB_OUTPUT
            echo "rust_unchanged=false" >> $GITHUB_OUTPUT
          else
            echo "python_unchanged=true" >> $GITHUB_OUTPUT
            echo "rust_unchanged=true" >> $GITHUB_OUTPUT
          fi

  # ============================================================
  # Build shared artifacts once, cache them, reuse across platforms
  # ============================================================

  build-shared-artifacts:
    name: ðŸ”§ Build Shared Artifacts (Dashboard + Rust Core)
    runs-on: ubuntu-latest
    needs: detect-changes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Configure Cachix
        uses: cachix/cachix-action@v14
        with:
          name: exo
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      # â”€â”€â”€ Dashboard Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ“Š Restore cached dashboard
        id: cache-dashboard
        uses: actions/cache/restore@v4
        with:
          path: dashboard/build
          key: ${{ needs.detect-changes.outputs.cache_key_nix }}-dashboard
          restore-keys: |
            ${{ env.CACHE_VERSION }}-nix--dashboard

      - name: Build dashboard (if cache miss)
        if: steps.cache-dashboard.outputs.cache-hit != 'true'
        run: |
          echo "ðŸ—ï¸  Building dashboard (not in cache)..."
          nix build .#dashboard --print-build-logs --no-link --print-out-paths > /tmp/dashboard-out
          DASHBOARD_OUT=$(cat /tmp/dashboard-out)
          mkdir -p dashboard/build
          cp -r "$DASHBOARD_OUT"/* dashboard/build/
          echo "âœ… Dashboard built successfully"

      - name: ðŸ’¾ Save dashboard to cache
        if: steps.cache-dashboard.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: dashboard/build
          key: ${{ needs.detect-changes.outputs.cache_key_nix }}-dashboard

      - name: "âœ… Using cached dashboard (no changes)"
        if: steps.cache-dashboard.outputs.cache-hit == 'true'
        run: echo "Skipping dashboard build - cache hit"

      # â”€â”€â”€ Rust Core Libraries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: ðŸ”§ Restore Rust build cache
        id: cache-rust
        uses: actions/cache/restore@v4
        with:
          path: |
            rust/target
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ needs.detect-changes.outputs.cache_key_rust }}-core
          restore-keys: |
            ${{ env.CACHE_VERSION }}-rs--core

      - name: Build Rust core libraries (if cache miss)
        if: steps.cache-rust.outputs.cache-hit != 'true' || needs.detect-changes.outputs.rust_deps_unchanged == 'false'
        run: |
          cd rust
          echo "ðŸ”¨ Building Rust core (not in cache)..."
          cargo build --release -p exo_pyo3_bindings
          echo "âœ… Rust core built successfully"

      - name: ðŸ’¾ Save Rust build cache
        if: steps.cache-rust.outputs.cache-hit != 'true' || needs.detect-changes.outputs.rust_deps_unchanged == 'false'
        uses: actions/cache/save@v4
        with:
          path: |
            rust/target
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ needs.detect-changes.outputs.cache_key_rust }}-core

      - name: "âœ… Using cached Rust core (no changes)"
        if: steps.cache-rust.outputs.cache-hit == 'true' && needs.detect-changes.outputs.rust_deps_unchanged == 'true'
        run: echo "Skipping Rust build - dependencies unchanged"

      # â”€â”€â”€ Upload shared artifacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: ðŸ“¤ Upload shared dashboard
        uses: actions/upload-artifact@v4
        with:
          name: shared-artifacts-dashboard
          path: dashboard/build
          retention-days: 1
          if-no-files-found: ignore

      - name: ðŸ“¤ Upload shared Rust libs
        uses: actions/upload-artifact@v4
        with:
          name: shared-artifacts-rust
          path: rust/target/release
          retention-days: 1
          if-no-files-found: ignore

  # ============================================================
  # Test all platforms (if not skipped)
  # ============================================================

  test-all:
    name: ðŸ§ª Run All Tests
    needs: [detect-changes, build-shared-artifacts]
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - uses: cachix/cachix-action@v14
        with:
          name: exo
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Run type checking
        run: nix flake check

      - name: Download shared artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: shared-artifacts-*
          path: shared-artifacts

      - name: Run tests with shared artifacts
        run: |
          nix develop --command bash -c '
            echo "ðŸ§ª Running tests..."
            uv run pytest -xvs --tb=short
            echo "âœ… All tests passed"
          '

  # ============================================================
  # Build for all platforms (in parallel, using shared artifacts)
  # ============================================================

  call-build-linux:
    name: ðŸ§ Build Linux
    needs: [detect-changes, build-shared-artifacts, test-all]
    if: needs.detect-changes.outputs.build_linux == 'true' && !failure()
    uses: ./.github/workflows/build-linux.yml
    secrets: inherit
    with:
      version: ${{ needs.detect-changes.outputs.version }}

  call-build-windows:
    name: ðŸªŸ Build Windows
    needs: [detect-changes, build-shared-artifacts, test-all]
    if: needs.detect-changes.outputs.build_windows == 'true' && !failure()
    uses: ./.github/workflows/build-windows.yml
    secrets: inherit
    with:
      version: ${{ needs.detect-changes.outputs.version }}

  call-build-macos:
    name: ðŸŽ Build macOS
    needs: [detect-changes, build-shared-artifacts, test-all]
    if: needs.detect-changes.outputs.build_macos == 'true' && !failure()
    uses: ./.github/workflows/build-app.yml
    secrets: inherit

  call-build-android:
    name: ðŸ“± Build Android
    needs: [detect-changes, build-shared-artifacts, test-all]
    if: needs.detect-changes.outputs.build_android == 'true' && !failure()
    uses: ./.github/workflows/build-android.yml
    secrets: inherit
    with:
      version: ${{ needs.detect-changes.outputs.version }}

  # ============================================================
  # Verify all builds completed successfully
  # ============================================================

  verify-builds:
    name: âœ… Verify All Builds
    needs: [detect-changes, call-build-linux, call-build-windows, call-build-macos, call-build-android]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: ðŸ“Š Generate release manifest
        run: |
          cat > RELEASE_MANIFEST.md << 'EOF'
          # ðŸ“¦ Release Manifest: v${{ needs.detect-changes.outputs.version }}
          
          ## Build Status
          
          | Platform | Status | Count |
          |:---|:---|---:|
          EOF
          
          for platform in linux windows macos android; do
            file_count=$(find all-artifacts -path "*$platform*" -type f | wc -l)
            if [ $file_count -gt 0 ]; then
              echo "| $platform | âœ… | $file_count |" >> RELEASE_MANIFEST.md
            else
              echo "| $platform | â­ï¸ | skipped |" >> RELEASE_MANIFEST.md
            fi
          done
          
          echo "" >> RELEASE_MANIFEST.md
          echo "## Artifacts Summary" >> RELEASE_MANIFEST.md
          echo "" >> RELEASE_MANIFEST.md
          
          total_files=$(find all-artifacts -type f | wc -l)
          total_size=$(du -sh all-artifacts | cut -f1)
          
          echo "- **Total artifacts**: $total_files files" >> RELEASE_MANIFEST.md
          echo "- **Total size**: $total_size" >> RELEASE_MANIFEST.md
          echo "- **Generated**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> RELEASE_MANIFEST.md
          
          cat RELEASE_MANIFEST.md

      - name: âœ”ï¸ Verify minimum artifacts
        run: |
          total=$(find all-artifacts -type f | wc -l)
          if [ $total -lt 5 ]; then
            echo "âŒ ERROR: Only $total artifacts (expected 5+)"
            find all-artifacts -type f
            exit 1
          fi
          echo "âœ… Build verification passed ($total artifacts)"

  # ============================================================
  # Create and publish release
  # ============================================================

  create-release:
    name: ðŸš€ Create GitHub Release
    needs: [detect-changes, verify-builds]
    runs-on: ubuntu-latest
    if: success()
    outputs:
      release_id: ${{ steps.create.outputs.id }}

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate release notes
        id: notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # Release v${{ needs.detect-changes.outputs.version }}
          
          ## ðŸŽ‰ What's New
          
          - Cross-platform builds fully automated
          - Optimized build pipeline with smart caching
          - GPU support verified on all platforms
          - Improved artifact sharing across builds
          
          ## ðŸ“¥ Downloads
          
          ### ðŸ§ Linux
          - Debian/Ubuntu (.deb)
          - Fedora/RHEL (.rpm)
          - Alpine (.apk)
          - Arch Linux (.pkg.tar.zst)
          - AppImage, Flatpak, Snap
          
          ### ðŸªŸ Windows
          - NSIS Installer (.exe)
          - Portable ZIP
          
          ### ðŸŽ macOS
          - DMG (code-signed & notarized)
          
          ### ðŸ“± Mobile
          - Android (Google Play)
          - iOS (App Store)
          
          ## âœ… Verification
          
          All packages are signed and verified:
          
          ```bash
          sha256sum -c SHA256SUMS
          ```
          
          EOF
          
          echo "Release notes generated"

      - name: ðŸ“¤ Create GitHub Release
        id: create
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.detect-changes.outputs.version }}
          name: "Release v${{ needs.detect-changes.outputs.version }}"
          body_path: RELEASE_NOTES.md
          files: artifacts/**/*
          draft: false
          prerelease: ${{ needs.detect-changes.outputs.is_prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # Publish to package managers (parallel)
  # ============================================================

  publish-packages:
    name: ðŸ“¦ Publish to Package Managers
    needs: [detect-changes, create-release]
    runs-on: ubuntu-latest
    if: success()

    strategy:
      matrix:
        manager:
          - apt
          - dnf
          - snap
          - flatpak
      max-parallel: 2

    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ðŸ“¤ Publish to ${{ matrix.manager }}
        run: |
          case "${{ matrix.manager }}" in
            apt)
              if [ -n "${{ secrets.LAUNCHPAD_CREDENTIALS }}" ]; then
                echo "Publishing to APT..."
                apt-get update && apt-get install -y dput devscripts
                # dput logic here
                echo "âœ… APT published"
              else
                echo "â­ï¸  APT credentials not configured"
              fi
              ;;
            dnf)
              if [ -n "${{ secrets.COPR_CREDENTIALS }}" ]; then
                echo "Publishing to DNF..."
                pip3 install copr-cli
                # copr-cli logic here
                echo "âœ… DNF published"
              else
                echo "â­ï¸  DNF credentials not configured"
              fi
              ;;
            snap)
              if [ -n "${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}" ]; then
                echo "Publishing to Snap..."
                apt-get update && apt-get install -y snapcraft
                # snapcraft logic here
                echo "âœ… Snap published"
              else
                echo "â­ï¸  Snap credentials not configured"
              fi
              ;;
            flatpak)
              echo "Flatpak publication via Flathub PR"
              echo "âœ… Ready for Flathub"
              ;;
          esac

  # ============================================================
  # Notifications and cleanup
  # ============================================================

  notify-completion:
    name: ðŸ“¢ Release Complete
    needs: [detect-changes, verify-builds, create-release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ðŸ“Š Generate summary
        run: |
          cat << 'EOF'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘   ðŸŽ‰ Release v${{ needs.detect-changes.outputs.version }} Complete!
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸ“¦ Artifacts Published
          âœ… GitHub Release
          ðŸ§ Linux packages (apt, dnf, snap, flatpak)
          ðŸªŸ Windows (NSIS, portable)
          ðŸŽ macOS (DMG)
          ðŸ“± Android (Google Play)
          
          Download: https://github.com/${{ github.repository }}/releases
          
          EOF

      - name: ðŸ”” Slack notification
        if: secrets.SLACK_WEBHOOK != ''
        run: |
          curl -X POST "${{ secrets.SLACK_WEBHOOK }}" \
            -H 'Content-Type: application/json' \
            -d "{\"text\":\"ðŸš€ Release v${{ needs.detect-changes.outputs.version }} published to all platforms!\"}"

      - name: Cleanup old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            // Keep only last 3 releases' artifacts
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const toDelete = releases.data.slice(3);
            for (const release of toDelete) {
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id
              });
            }
