name: Build Android

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (e.g., v1.0.0)"
        required: true
  workflow_call:
    inputs:
      version:
        description: "Version to build"
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-android:
    name: Build Android APK/AAB
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ -n "${{ inputs.version }}" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION#v}"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Setup Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Configure Cachix
        uses: cachix/cachix-action@v14
        with:
          name: exo
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Setup Android NDK
        uses: ndk-build/setup-android-ndk@v1
        with:
          ndk-version: r26d
          add-to-path: true

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Build dashboard
        run: |
          nix build .#dashboard --print-build-logs --no-link --print-out-paths > /tmp/dashboard-out
          DASHBOARD_OUT=$(cat /tmp/dashboard-out)
          mkdir -p android/app/src/main/assets/dashboard
          cp -r "$DASHBOARD_OUT"/* android/app/src/main/assets/dashboard/

      - name: Build native libraries
        run: |
          cd rust
          
          echo "Building for aarch64-linux-android..."
          cargo build --release --target aarch64-linux-android -p exo_pyo3_bindings
          
          echo "Building for armv7-linux-androideabi..."
          cargo build --release --target armv7-linux-androideabi -p exo_pyo3_bindings
          
          echo "Building for x86_64-linux-android..."
          cargo build --release --target x86_64-linux-android -p exo_pyo3_bindings
          
          echo "Building for i686-linux-android..."
          cargo build --release --target i686-linux-android -p exo_pyo3_bindings

      - name: Copy native libraries to Android project
        run: |
          mkdir -p android/app/src/main/jniLibs
          
          # Copy ARM64
          mkdir -p android/app/src/main/jniLibs/arm64-v8a
          cp rust/target/aarch64-linux-android/release/libexo_pyo3_bindings.so \
             android/app/src/main/jniLibs/arm64-v8a/
          
          # Copy ARMv7
          mkdir -p android/app/src/main/jniLibs/armeabi-v7a
          cp rust/target/armv7-linux-androideabi/release/libexo_pyo3_bindings.so \
             android/app/src/main/jniLibs/armeabi-v7a/
          
          # Copy x86_64
          mkdir -p android/app/src/main/jniLibs/x86_64
          cp rust/target/x86_64-linux-android/release/libexo_pyo3_bindings.so \
             android/app/src/main/jniLibs/x86_64/
          
          # Copy x86
          mkdir -p android/app/src/main/jniLibs/x86
          cp rust/target/i686-linux-android/release/libexo_pyo3_bindings.so \
             android/app/src/main/jniLibs/x86/

      - name: Setup Python for Android
        run: |
          # Setup Python.zip and other assets needed by the Android app
          mkdir -p android/app/src/main/assets/python
          # This would typically include pre-built Python for Android

      - name: Build APK (debug)
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug \
            -PversionName="${{ steps.version.outputs.version }}" \
            -PversionCode=$(echo $((2024000 + $(git rev-list --count HEAD))))

      - name: Build APK (release)
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease \
            -PversionName="${{ steps.version.outputs.version }}" \
            -PversionCode=$(echo $((2024000 + $(git rev-list --count HEAD))))

      - name: Build AAB (App Bundle)
        run: |
          cd android
          chmod +x gradlew
          ./gradlew bundleRelease \
            -PversionName="${{ steps.version.outputs.version }}" \
            -PversionCode=$(echo $((2024000 + $(git rev-list --count HEAD))))

      - name: Sign APK and AAB
        if: secrets.ANDROID_KEYSTORE_BASE64 != ''
        run: |
          # Decode keystore
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android.keystore
          
          # Sign APK with jarsigner
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore android.keystore \
            -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            -keypass "${{ secrets.ANDROID_KEY_PASSWORD }}" \
            android/app/build/outputs/apk/release/app-release-unsigned.apk \
            "${{ secrets.ANDROID_KEY_ALIAS }}"
          
          # Verify signature
          jarsigner -verify -verbose android/app/build/outputs/apk/release/app-release-unsigned.apk
          
          # Rename to signed
          mv android/app/build/outputs/apk/release/app-release-unsigned.apk \
             android/app/build/outputs/apk/release/app-release.apk
          
          # Also sign AAB using Google Play API
          # This is typically done via upload-google-play action

      - name: Create universal APK
        run: |
          cd android
          ./gradlew assembleRelease -Pbundle=false
          
          # Rename for clarity
          cp app/build/outputs/apk/release/app-release.apk \
             app/build/outputs/apk/release/exo-universal-${{ steps.version.outputs.version }}.apk

      - name: Generate checksums
        run: |
          mkdir -p dist
          cp android/app/build/outputs/apk/release/*.apk dist/
          cp android/app/build/outputs/bundle/release/*.aab dist/ || true
          
          cd dist
          sha256sum * > SHA256SUMS
          sha512sum * > SHA512SUMS

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: exo-android-apk
          path: |
            dist/*.apk
            dist/SHA256SUMS
            dist/SHA512SUMS
          retention-days: 7

      - name: Upload AAB artifacts
        uses: actions/upload-artifact@v4
        if: hashFiles('dist/*.aab') != ''
        with:
          name: exo-android-aab
          path: |
            dist/*.aab
            dist/SHA256SUMS
            dist/SHA512SUMS
          retention-days: 7

      - name: Upload to S3 (if configured)
        if: secrets.AWS_S3_BUCKET != '' && startsWith(github.ref, 'refs/tags/')
        run: |
          apt-get update
          apt-get install -y awscli
          cd dist
          for file in *; do
            aws s3 cp "$file" "s3://${{ secrets.AWS_S3_BUCKET }}/releases/${{ steps.version.outputs.version }}/$file"
          done
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1

  publish-google-play:
    name: Publish to Google Play
    needs: build-android
    runs-on: ubuntu-latest
    if: secrets.GOOGLE_PLAY_SERVICE_ACCOUNT != '' && startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download AAB artifacts
        uses: actions/download-artifact@v4
        with:
          name: exo-android-aab
          path: aab-artifacts

      - name: Upload to Google Play (internal testing)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: io.exo.app
          releaseFiles: aab-artifacts/*.aab
          track: internal
          status: inProgress
          mappingFile: android/app/build/outputs/mapping/release/mapping.txt

      - name: Create GitHub Release annotation
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ“± Android build uploaded to Google Play internal testing track'
            })
