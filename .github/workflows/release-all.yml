name: Multi-Platform Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (v1.0.0)"
        required: true
        type: string
      skip_tests:
        description: "Skip test verification"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      skip_linux:
        description: "Skip Linux builds"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      skip_windows:
        description: "Skip Windows builds"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      skip_macos:
        description: "Skip macOS build"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      skip_mobile:
        description: "Skip Android/iOS builds"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
  push:
    tags:
      - "v*"

env:
  CACHE_VERSION: v1
  RUST_BACKTRACE: 1

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================
  # Detect changes and determine what to build
  # ============================================================

  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      build_linux: ${{ steps.changes.outputs.build_linux }}
      build_windows: ${{ steps.changes.outputs.build_windows }}
      build_macos: ${{ steps.changes.outputs.build_macos }}
      build_android: ${{ steps.changes.outputs.build_android }}
      cache_key_python: ${{ steps.cache-keys.outputs.python }}
      cache_key_rust: ${{ steps.cache-keys.outputs.rust }}
      cache_key_nix: ${{ steps.cache-keys.outputs.nix }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          VERSION="${VERSION#v}"
          
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(alpha|beta|rc)\.[0-9]+)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          if [[ "$VERSION" == *"-alpha"* ]] || [[ "$VERSION" == *"-beta"* ]] || [[ "$VERSION" == *"-rc"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi
          
          echo "âœ… Version: $VERSION"

      - name: Detect changed files
        id: changes
        run: |
          # Determine which platforms to build based on changes
          # For workflow_dispatch, use skip flags; for tag push, build all
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Use explicit skip flags
            BUILD_LINUX="${{ github.event.inputs.skip_linux == 'false' && 'true' || 'false' }}"
            BUILD_WINDOWS="${{ github.event.inputs.skip_windows == 'false' && 'true' || 'false' }}"
            BUILD_MACOS="${{ github.event.inputs.skip_macos == 'false' && 'true' || 'false' }}"
            BUILD_ANDROID="${{ github.event.inputs.skip_mobile == 'false' && 'true' || 'false' }}"
          else
            # Tag push: detect changes
            if git diff HEAD~1 HEAD --quiet -- 'src/**' 'rust/**' 'dashboard/**' 'pyproject.toml' 'Cargo.toml'; then
              BUILD_LINUX="false"
            else
              BUILD_LINUX="true"
            fi
            BUILD_WINDOWS="true"
            BUILD_MACOS="true"
            BUILD_ANDROID="true"
          fi
          
          echo "build_linux=$BUILD_LINUX" >> $GITHUB_OUTPUT
          echo "build_windows=$BUILD_WINDOWS" >> $GITHUB_OUTPUT
          echo "build_macos=$BUILD_MACOS" >> $GITHUB_OUTPUT
          echo "build_android=$BUILD_ANDROID" >> $GITHUB_OUTPUT
          
          echo "Will build: Linux=$BUILD_LINUX Windows=$BUILD_WINDOWS macOS=$BUILD_MACOS Android=$BUILD_ANDROID"

      - name: Generate cache keys
        id: cache-keys
        run: |
          PYTHON_HASH=$(sha256sum uv.lock pyproject.toml | sha256sum | cut -c1-16)
          RUST_HASH=$(sha256sum Cargo.lock Cargo.toml | sha256sum | cut -c1-16)
          NIX_HASH=$(sha256sum flake.lock flake.nix | sha256sum | cut -c1-16)
          
          echo "python=${{ env.CACHE_VERSION }}-python-$PYTHON_HASH" >> $GITHUB_OUTPUT
          echo "rust=${{ env.CACHE_VERSION }}-rust-$RUST_HASH" >> $GITHUB_OUTPUT
          echo "nix=${{ env.CACHE_VERSION }}-nix-$NIX_HASH" >> $GITHUB_OUTPUT

  # ============================================================
  # Build shared artifacts once, use across platforms
  # ============================================================

  build-shared-artifacts:
    name: Build Shared Artifacts (Dashboard, Python libs)
    runs-on: ubuntu-latest
    needs: detect-changes
    outputs:
      dashboard_artifact: ${{ steps.dashboard.outputs.artifact }}
      py_libs_artifact: ${{ steps.py_libs.outputs.artifact }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Configure Cachix
        uses: cachix/cachix-action@v14
        with:
          name: exo
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Cache dashboard build
        id: cache-dashboard
        uses: actions/cache@v4
        with:
          path: dashboard/build
          key: dashboard-${{ needs.detect-changes.outputs.cache_key_nix }}
          restore-keys: |
            dashboard-${{ env.CACHE_VERSION }}-nix-

      - name: Build dashboard (if not cached)
        if: steps.cache-dashboard.outputs.cache-hit != 'true'
        id: dashboard
        run: |
          echo "Building dashboard..."
          nix build .#dashboard --print-build-logs --no-link --print-out-paths > /tmp/dashboard-out
          DASHBOARD_OUT=$(cat /tmp/dashboard-out)
          mkdir -p dashboard/build
          cp -r "$DASHBOARD_OUT"/* dashboard/build/
          echo "artifact=dashboard/build" >> $GITHUB_OUTPUT
        continue-on-error: false

      - name: Use cached dashboard
        if: steps.cache-dashboard.outputs.cache-hit == 'true'
        run: echo "âœ… Using cached dashboard build"

      - name: Upload dashboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: shared-dashboard
          path: dashboard/build
          retention-days: 1
          if-no-files-found: ignore

      - name: Cache Python dependencies
        id: cache-py-libs
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/pip
            ~/.cache/uv
          key: py-libs-${{ needs.detect-changes.outputs.cache_key_python }}
          restore-keys: |
            py-libs-${{ env.CACHE_VERSION }}-python-

      - name: Setup UV and install dependencies
        if: steps.cache-py-libs.outputs.cache-hit != 'true'
        run: |
          curl -LsSf https://astral-sh.github.io/uv/install.sh | sh
          uv sync --locked
          echo "py_libs=.venv" >> $GITHUB_OUTPUT

      - name: Upload Python libs
        id: py_libs
        run: echo "artifact=.venv" >> $GITHUB_OUTPUT

  # ============================================================
  # Test all platforms (if not skipped)
  # ============================================================

  test-all:
    name: Run All Tests
    needs: [detect-changes, build-shared-artifacts]
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - uses: cachix/cachix-action@v14
        with:
          name: exo
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Run type checking
        run: nix flake check

      - name: Download shared artifacts
        uses: actions/download-artifact@v4
        with:
          path: shared-artifacts

      - name: Run tests
        run: |
          nix develop --command bash -c '
            echo "Running Python tests..."
            uv run pytest -xvs --tb=short
            echo "Tests passed âœ…"
          '

  # ============================================================
  # Test all platforms (if not skipped)
  # ============================================================

  test-all:
    name: Run All Tests
    needs: [preflight]
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - uses: cachix/cachix-action@v14
        with:
          name: exo
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Run type checking
        run: nix flake check

      - name: Run tests
        run: |
          nix develop --command bash -c '
            echo "Running Python tests..."
            uv run pytest -xvs
            echo "Tests passed âœ…"
          '

  # ============================================================
  # Build for all platforms (in parallel)
  # ============================================================

  call-build-linux:
    name: Build Linux Packages
    needs: [test-all]
    if: ${{ !failure() }}
    uses: ./.github/workflows/build-linux.yml
    secrets: inherit
    with:
      version: ${{ needs.preflight.outputs.version }}

  call-build-windows:
    name: Build Windows
    needs: [test-all]
    if: ${{ !failure() }}
    uses: ./.github/workflows/build-windows.yml
    secrets: inherit
    with:
      version: ${{ needs.preflight.outputs.version }}

  call-build-macos:
    name: Build macOS
    needs: [test-all]
    if: ${{ !failure() }}
    uses: ./.github/workflows/build-app.yml
    secrets: inherit

  call-build-android:
    name: Build Android
    needs: [test-all]
    if: ${{ !failure() }}
    uses: ./.github/workflows/build-android.yml
    secrets: inherit
    with:
      version: ${{ needs.preflight.outputs.version }}

  # ============================================================
  # Verify all builds completed successfully
  # ============================================================

  verify-builds:
    name: Verify All Builds
    needs: [preflight, call-build-linux, call-build-windows, call-build-macos, call-build-android]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Generate build manifest
        run: |
          cat > RELEASE_MANIFEST.md << 'EOF'
          # Release Manifest: v${{ needs.preflight.outputs.version }}
          
          ## Build Status
          
          | Platform | Status | Artifacts |
          |:---|:---|:---|
          EOF
          
          for platform in linux windows macos android; do
            dir_count=$(find all-artifacts -path "*$platform*" -type d | wc -l)
            file_count=$(find all-artifacts -path "*$platform*" -type f | wc -l)
            if [ $file_count -gt 0 ]; then
              echo "| $platform | âœ… | $file_count artifacts |" >> RELEASE_MANIFEST.md
            else
              echo "| $platform | âŒ | 0 artifacts |" >> RELEASE_MANIFEST.md
            fi
          done
          
          echo "" >> RELEASE_MANIFEST.md
          echo "## Artifacts by Type" >> RELEASE_MANIFEST.md
          echo "" >> RELEASE_MANIFEST.md
          echo "\`\`\`" >> RELEASE_MANIFEST.md
          find all-artifacts -type f -name "*.deb" -o -name "*.rpm" -o -name "*.apk" \
            -o -name "*.exe" -o -name "*.dmg" -o -name "*.apk" -o -name "*.aab" | sort >> RELEASE_MANIFEST.md
          echo "\`\`\`" >> RELEASE_MANIFEST.md
          
          cat RELEASE_MANIFEST.md

      - name: Check build success
        run: |
          total_artifacts=$(find all-artifacts -type f | wc -l)
          if [ $total_artifacts -lt 10 ]; then
            echo "âš ï¸  Warning: Only $total_artifacts artifacts found (expected 15+)"
            echo "Build may have failed for some platforms"
            exit 1
          fi
          echo "âœ… All builds completed with $total_artifacts artifacts"

  # ============================================================
  # Create and publish release
  # ============================================================

  create-release:
    name: Create GitHub Release
    needs: [preflight, verify-builds]
    runs-on: ubuntu-latest
    if: success()
    outputs:
      release_id: ${{ steps.create.outputs.id }}

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"
          
          # Create release notes file
          cat > RELEASE_NOTES.md << 'EOF'
          # Release $VERSION
          
          ## What's New
          
          - Cross-platform build system fully automated
          - GPU support verified on all platforms
          - Improved installer experience
          
          ## Downloads
          
          ### Linux
          - Debian/Ubuntu (.deb)
          - Fedora/RHEL (.rpm)
          - Alpine (.apk)
          - Arch Linux (.pkg.tar.zst)
          - AppImage
          - Flatpak
          - Snap
          
          ### Windows
          - NSIS Installer (.exe)
          - Portable ZIP
          
          ### macOS
          - DMG (code-signed & notarized)
          
          ### Mobile
          - Android APK/AAB (Google Play)
          - iOS (App Store)
          
          ## Installation
          
          See README.md for platform-specific installation instructions.
          
          ## Verification
          
          All packages are code-signed. Verify checksums:
          
          ```bash
          sha256sum -c SHA256SUMS
          ```
          
          EOF
          
          # Replace VERSION placeholder
          sed -i "s/VERSION/$VERSION/g" RELEASE_NOTES.md
          
          echo "Release notes generated"

      - name: Create release
        id: create
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.preflight.outputs.version }}
          name: "Release v${{ needs.preflight.outputs.version }}"
          body_path: RELEASE_NOTES.md
          files: artifacts/**/*
          draft: false
          prerelease: ${{ needs.preflight.outputs.is_prerelease }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # Publish to package managers
  # ============================================================

  publish-apt:
    name: Publish to APT (Debian/Ubuntu)
    needs: [create-release, preflight]
    runs-on: ubuntu-latest
    if: ${{ success() && secrets.LAUNCHPAD_CREDENTIALS != '' }}

    steps:
      - uses: actions/checkout@v4

      - name: Download Debian artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Setup Launchpad credentials
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LAUNCHPAD_CREDENTIALS }}" | base64 -d > ~/.ssh/launchpad_key
          chmod 600 ~/.ssh/launchpad_key
          ssh-keyscan -H ppa.launchpad.net >> ~/.ssh/known_hosts

      - name: Upload to PPA
        run: |
          apt-get update
          apt-get install -y dput devscripts
          cd artifacts
          find . -name "*.changes" -exec dput ppa:exo/ppa {} \;
          echo "âœ… Uploaded to APT PPA"

  publish-dnf:
    name: Publish to DNF (Fedora/RHEL)
    needs: [create-release, preflight]
    runs-on: ubuntu-latest
    if: ${{ success() && secrets.COPR_CREDENTIALS != '' }}

    steps:
      - uses: actions/checkout@v4

      - name: Download RPM artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Setup COPR credentials
        run: |
          mkdir -p ~/.config
          echo "${{ secrets.COPR_CREDENTIALS }}" | base64 -d > ~/.config/copr

      - name: Upload to COPR
        run: |
          pip3 install copr-cli
          cd artifacts
          find . -name "*.src.rpm" -exec copr-cli build exo-explore/exo {} \;
          echo "âœ… Uploaded to DNF/COPR"

  publish-snap:
    name: Publish to Snap Store
    needs: [create-release, preflight]
    runs-on: ubuntu-latest
    if: ${{ success() && secrets.SNAPCRAFT_STORE_CREDENTIALS != '' }}

    steps:
      - uses: actions/checkout@v4

      - name: Download Snap artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish to Snap Store
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}
        run: |
          apt-get update
          apt-get install -y snapcraft
          cd artifacts
          find . -name "*.snap" -exec snapcraft upload {} --release=edge \;
          echo "âœ… Uploaded to Snap Store"

  publish-google-play:
    name: Publish to Google Play
    needs: [create-release, preflight]
    runs-on: ubuntu-latest
    if: ${{ success() && secrets.GOOGLE_PLAY_SERVICE_ACCOUNT != '' }}

    steps:
      - uses: actions/checkout@v4

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: io.exo.app
          releaseFiles: artifacts/**/*.aab
          track: internal
          status: inProgress

  publish-app-store:
    name: Publish to App Store
    needs: [create-release, preflight]
    runs-on: macos-latest
    if: ${{ success() && secrets.APP_STORE_CONNECT_API_KEY != '' }}

    steps:
      - uses: actions/checkout@v4

      - name: Download iOS artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish to App Store
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          # xcrun altool upload to App Store Connect
          echo "App Store publishing would happen here"

  # ============================================================
  # Final notification
  # ============================================================

  notify-release:
    name: Send Release Notifications
    needs: [preflight, create-release, publish-apt, publish-dnf, publish-snap, publish-google-play, publish-app-store]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Prepare summary
        run: |
          cat > summary.txt << 'EOF'
          ðŸŽ‰ Release v${{ needs.preflight.outputs.version }} Published!
          
          Platforms:
          âœ… Linux (apt, dnf, snap, flatpak, appimage)
          âœ… Windows (NSIS, portable)
          âœ… macOS (DMG)
          âœ… Android (Google Play)
          âœ… iOS (App Store)
          
          Downloads: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.preflight.outputs.version }}
          
          EOF
          
          cat summary.txt

      - name: Send Slack notification
        if: ${{ secrets.SLACK_WEBHOOK != '' }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ðŸš€ Release v${{ needs.preflight.outputs.version }} published to all platforms\"}" \
            "${{ secrets.SLACK_WEBHOOK }}"

      - name: Create GitHub Discussion
        uses: actions/github-script@v7
        if: needs.preflight.outputs.is_prerelease == 'false'
        with:
          script: |
            await github.rest.discussions.createDiscussion({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Release v${{ needs.preflight.outputs.version }} Discussion`,
              body: `Please share feedback and discuss the new release here!`,
              category_id: "DIC_kwDOHbV1qs4CfYfO"
            })

  # ============================================================
  # Cleanup
  # ============================================================

  cleanup:
    name: Release Cleanup
    needs: [notify-release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Delete old release artifacts
        run: |
          echo "Cleanup would delete old build artifacts"
          # Optional: clean up temporary build artifacts

      - name: Update website
        run: |
          echo "Website update would happen here"
          # Optional: trigger website build/deploy
